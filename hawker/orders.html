<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders - Hawker Portal</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/hawker.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="hawker-dashboard">
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-brand" style="display: flex; width: 100%; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-receipt"></i>
                <span style="font-size: 0.95em; font-weight: 500;">Orders</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                <span id="stallName" style="font-size: 1.1em; font-weight: 600;">Loading...</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                <span id="foodCourtName" style="font-size: 0.85em; opacity: 0.75;">Loading...</span>
            </div>
        </div>
    </nav>
    
    <main class="dashboard-content">
        <div class="orders-container" id="ordersContainer">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading orders...</p>
            </div>
        </div>
    </main>
    
    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav hawker-nav">
        <a href="orders.html" class="nav-item active">
            <i class="fas fa-receipt"></i>
            <span>Orders</span>
        </a>
        <a href="order-history.html" class="nav-item">
            <i class="fas fa-history"></i>
            <span>History</span>
        </a>
        <a href="menu-management.html" class="nav-item">
            <i class="fas fa-utensils"></i>
            <span>Menu</span>
        </a>
        <a href="settings.html" class="nav-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
    </nav>
    
    <script src="../js/app.js"></script>
    <script src="../js/orders.js"></script>
    <script>
        let session = null;
        let allOrders = [];
        let supabase;
        let hawkerStall = null;
        
        // Initialize Supabase
        function initializeSupabase() {
            try {
                const SUPABASE_URL = 'https://mtmkghuhhrerlcubhzot.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10bWtnaHVoaHJlcmxjdWJoem90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Mzc5NzIsImV4cCI6MjA3NzExMzk3Mn0.kA-NUWidhSRNPotmVe3KIclk8LpizR26DzxIBn5C1rA';
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase connected successfully!');
                return true;
            } catch (error) {
                console.error('❌ Failed to initialize Supabase:', error);
                return false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (initializeSupabase()) {
                checkAuth();
                loadOrders();
                
                // Auto-refresh every 15 seconds
                setInterval(loadOrders, 15000);
            }
        });
        
        async function checkAuth() {
            const sessionData = localStorage.getItem('hawkerSession') || sessionStorage.getItem('hawkerSession');
            if (!sessionData) {
                window.location.href = 'login.html';
                return;
            }
            session = JSON.parse(sessionData);
            
            // Load hawker stall information from Supabase to get food court name
            try {
                const { data, error } = await supabase
                    .from('hawker_stalls')
                    .select(`
                        *,
                        food_courts:food_court_id (
                            name,
                            address
                        )
                    `)
                    .eq('hawker_id', session.userId)
                    .eq('status', 'active')
                    .single();
                
                if (error) throw error;
                
                hawkerStall = data;
                // Display food court name and stall name
                document.getElementById('foodCourtName').textContent = data.food_courts?.name || 'Food Court';
                document.getElementById('stallName').textContent = data.stall_name || session.stallName || 'My Stall';
                
                console.log('✅ Hawker stall loaded:', hawkerStall);
            } catch (error) {
                console.error('❌ Error loading hawker stall:', error);
                document.getElementById('foodCourtName').textContent = 'Food Court';
                document.getElementById('stallName').textContent = session.stallName || 'My Stall';
            }
        }
        
        function loadOrders() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            
            // Filter orders for this stall (only pending and ready, exclude completed)
            allOrders = orders.filter(order => {
                const stallOrder = order.stallOrders.find(so => so.stallName === session.stallName);
                if (!stallOrder) return false;
                
                const status = order.stallStatuses?.[session.stallName] || 'pending';
                return status === 'pending' || status === 'ready';
            }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            displayOrders();
        }
        
        function displayOrders() {
            const container = document.getElementById('ordersContainer');
            
            if (allOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>No active orders</p>
                        <small>Completed orders can be viewed in Order History</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allOrders.map(order => {
                const stallOrder = order.stallOrders.find(so => so.stallName === session.stallName);
                const status = order.stallStatuses?.[session.stallName] || 'pending';
                
                return `
                    <div class="order-detail-card">
                        <div class="order-card-header">
                            <div>
                                <h3>${order.orderId}</h3>
                                <span class="order-time"><i class="fas fa-clock"></i> ${formatTime(order.timestamp)}</span>
                            </div>
                            <div class="order-table">
                                <i class="fas fa-chair"></i> Table ${order.tableNumber}
                            </div>
                        </div>
                        
                        <div class="order-items-list">
                            ${stallOrder.items.map(item => `
                                <div class="order-item-row">
                                    <div class="item-info">
                                        <strong>${item.name}</strong> × ${item.quantity}
                                        ${item.specialInstructions ? 
                                            `<p class="item-note"><i class="fas fa-comment"></i> ${item.specialInstructions}</p>` 
                                            : ''}
                                    </div>
                                    <span>RM ${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="order-card-footer">
                            <div class="order-total">
                                <strong>Total: RM ${stallOrder.total.toFixed(2)}</strong>
                            </div>
                            <div class="order-status-actions">
                                <span class="status-badge status-${status}">${formatStatus(status)}</span>
                                ${status !== 'completed' ? `
                                    <button class="btn-primary btn-sm" onclick="updateOrderStatus('${order.orderId}', '${getNextStatus(status)}')">
                                        <i class="fas fa-arrow-right"></i> ${getNextStatusLabel(status)}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateOrderStatus(orderId, newStatus) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.orderId === orderId);
            
            if (order) {
                if (!order.stallStatuses) {
                    order.stallStatuses = {};
                }
                order.stallStatuses[session.stallName] = newStatus;
                
                localStorage.setItem('orders', JSON.stringify(orders));
                
                // Update current order if it's the active one
                const currentOrder = JSON.parse(localStorage.getItem('currentOrder') || 'null');
                if (currentOrder && currentOrder.orderId === orderId) {
                    currentOrder.stallStatuses = order.stallStatuses;
                    localStorage.setItem('currentOrder', JSON.stringify(currentOrder));
                }
                
                loadOrders();
                showToast(`Order status updated to ${formatStatus(newStatus)}`);
            }
        }
        
        function getNextStatus(currentStatus) {
            const flow = {
                'pending': 'ready',
                'ready': 'completed'
            };
            return flow[currentStatus] || 'completed';
        }
        
        function getNextStatusLabel(currentStatus) {
            const labels = {
                'pending': 'Mark Ready',
                'ready': 'Complete'
            };
            return labels[currentStatus] || 'Update';
        }
        
        function formatStatus(status) {
            const labels = {
                pending: 'Pending',
                ready: 'Ready',
                completed: 'Completed'
            };
            return labels[status] || status;
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
    </script>
</body>
</html>
