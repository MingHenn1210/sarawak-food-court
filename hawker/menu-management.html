<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Management - Hawker Portal</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/hawker.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="hawker-dashboard">
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-brand">
            <a href="dashboard.html"><i class="fas fa-arrow-left"></i></a>
            <span>Menu Management</span>
        </div>
    </nav>
    
    <main class="dashboard-content">
        <!-- Menu Items Grid -->
        <div class="menu-management" id="menuItems">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading menu...</p>
            </div>
        </div>
    </main>
    
    <!-- Floating Add Button -->
    <button class="fab-button" onclick="showAddItemModal()" title="Add New Item">
        <i class="fas fa-plus"></i>
    </button>
    
    <!-- Add/Edit Item Modal -->
    <div class="modal" id="itemModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 id="modalTitle">Add Menu Item</h2>
                <button class="modal-close" onclick="closeItemModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form class="modal-body" id="itemForm" onsubmit="saveItem(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="itemName">Item Name *</label>
                        <input type="text" id="itemName" required>
                    </div>
                    <div class="form-group">
                        <label for="itemPrice">Price (RM) *</label>
                        <input type="number" id="itemPrice" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="itemDescription">Description *</label>
                    <textarea id="itemDescription" rows="3" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="itemCategory">Category *</label>
                        <select id="itemCategory" required>
                            <option value="Main">Main Dish</option>
                            <option value="Side">Side Dish</option>
                            <option value="Drink">Drink</option>
                            <option value="Dessert">Dessert</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="itemImage">Image URL</label>
                        <input type="text" id="itemImage" placeholder="https://...">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="itemAvailable" checked>
                            Available for order
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="itemPopular">
                            Mark as popular
                        </label>
                    </div>
                </div>
                
                <input type="hidden" id="itemId">
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeItemModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save Item
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav hawker-nav">
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="orders.html" class="nav-item">
            <i class="fas fa-receipt"></i>
            <span>Orders</span>
        </a>
        <a href="menu-management.html" class="nav-item active">
            <i class="fas fa-utensils"></i>
            <span>Menu</span>
        </a>
        <a href="settings.html" class="nav-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
    </nav>
    
    <script src="../js/app.js"></script>
    <script src="../js/hawker.js"></script>
    <script>
        let session = null;
        let menuItems = [];
        let editingItemId = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadMenu();
        });
        
        function checkAuth() {
            const sessionData = localStorage.getItem('hawkerSession') || sessionStorage.getItem('hawkerSession');
            if (!sessionData) {
                window.location.href = 'login.html';
                return;
            }
            session = JSON.parse(sessionData);
        }
        
        async function loadMenu() {
            try {
                const response = await fetch('../data/menus.json');
                const allMenus = await response.json();
                
                // Get stall info
                const stallsResponse = await fetch('../data/stalls.json');
                const stalls = await stallsResponse.json();
                const myStall = stalls.find(s => s.name === session.stallName);
                
                if (myStall) {
                    menuItems = allMenus.filter(item => item.stallId === myStall.id);
                    displayMenu();
                }
            } catch (error) {
                console.error('Error loading menu:', error);
            }
        }
        
        function displayMenu() {
            const container = document.getElementById('menuItems');
            
            if (menuItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-utensils"></i>
                        <p>No menu items yet</p>
                        <button class="btn-primary" onclick="showAddItemModal()">
                            <i class="fas fa-plus"></i> Add Your First Item
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = menuItems.map(item => `
                <div class="menu-item-card ${!item.available ? 'unavailable' : ''}">
                    <div class="item-image" style="background-image: url('${item.image}')">
                        ${!item.available ? '<div class="unavailable-overlay">Unavailable</div>' : ''}
                        ${item.isPopular ? '<span class="popular-badge">Popular</span>' : ''}
                    </div>
                    <div class="item-details">
                        <h3>${item.name}</h3>
                        <p>${item.description}</p>
                        <div class="item-meta">
                            <span class="category">${item.category}</span>
                            <span class="price">RM ${item.price.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon" onclick="toggleAvailability(${item.id})" title="Toggle Availability">
                            <i class="fas fa-${item.available ? 'eye' : 'eye-slash'}"></i>
                        </button>
                        <button class="btn-icon" onclick="editItem(${item.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-danger" onclick="deleteItem(${item.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function showAddItemModal() {
            editingItemId = null;
            document.getElementById('modalTitle').textContent = 'Add Menu Item';
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('itemModal').classList.add('show');
        }
        
        function editItem(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            editingItemId = itemId;
            document.getElementById('modalTitle').textContent = 'Edit Menu Item';
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemDescription').value = item.description;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemImage').value = item.image;
            document.getElementById('itemAvailable').checked = item.available;
            document.getElementById('itemPopular').checked = item.isPopular || false;
            
            document.getElementById('itemModal').classList.add('show');
        }
        
        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('show');
            editingItemId = null;
        }
        
        function saveItem(event) {
            event.preventDefault();
            
            const itemData = {
                id: editingItemId || Date.now(),
                stallId: menuItems[0]?.stallId || 1,
                name: document.getElementById('itemName').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                description: document.getElementById('itemDescription').value,
                category: document.getElementById('itemCategory').value,
                image: document.getElementById('itemImage').value || 'https://via.placeholder.com/300',
                available: document.getElementById('itemAvailable').checked,
                isPopular: document.getElementById('itemPopular').checked
            };
            
            if (editingItemId) {
                const index = menuItems.findIndex(i => i.id === editingItemId);
                menuItems[index] = itemData;
                showToast('Item updated successfully!');
            } else {
                menuItems.push(itemData);
                showToast('Item added successfully!');
            }
            
            closeItemModal();
            displayMenu();
        }
        
        function toggleAvailability(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (item) {
                item.available = !item.available;
                displayMenu();
                showToast(`Item marked as ${item.available ? 'available' : 'unavailable'}`);
            }
        }
        
        function deleteItem(itemId) {
            if (confirm('Are you sure you want to delete this item?')) {
                menuItems = menuItems.filter(i => i.id !== itemId);
                displayMenu();
                showToast('Item deleted successfully!');
            }
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
    </script>
</body>
</html>
